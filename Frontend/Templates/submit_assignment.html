<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Assignment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        .container { max-width: 800px; margin: 40px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .assignment-info { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
        .info-row { display: flex; justify-content: space-between; margin: 10px 0; }
        .info-label { font-weight: bold; color: #666; }
        .info-value { color: #333; }
        .bonus-calculator { background: #e7f3ff; padding: 20px; border-radius: 8px; margin: 20px 0; }
        .bonus-value { font-size: 2em; font-weight: bold; color: #007bff; text-align: center; margin: 15px 0; }
        .form-group { margin: 20px 0; }
        .form-group label { display: block; margin-bottom: 10px; font-weight: bold; color: #333; }
        .file-input { width: 100%; padding: 15px; border: 2px dashed #007bff; border-radius: 8px; background: #f8f9fa; cursor: pointer; text-align: center; }
        .file-input:hover { background: #e7f3ff; }
        .btn { padding: 12px 30px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; }
        .btn:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; margin-left: 10px; }
        .btn-secondary:hover { background: #5a6268; }
        .warning { background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .info-box { background: #d1ecf1; border-left: 4px solid #0c5460; padding: 15px; margin: 20px 0; border-radius: 5px; color: #0c5460; }
        .success { background: #d4edda; border-left: 4px solid #28a745; padding: 15px; margin: 20px 0; border-radius: 5px; }
        .countdown { font-size: 1.2em; font-weight: bold; color: #dc3545; text-align: center; margin: 15px 0; }
        .mode-badge { display: inline-block; padding: 5px 15px; border-radius: 20px; font-size: 0.9em; font-weight: bold; margin-left: 10px; }
        .mode-online { background: #d1ecf1; color: #0c5460; }
        .mode-offline { background: #fff3cd; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Submit Assignment
            {% if assignment['submission_mode'] == 'online' %}
            <span class="mode-badge mode-online">üíª Online</span>
            {% else %}
            <span class="mode-badge mode-offline">üìÑ Offline</span>
            {% endif %}
        </h1>
        
        <div class="assignment-info">
            <h2>{{ assignment['title'] }}</h2>
            <div style="color: #666; margin-bottom: 15px;">{{ assignment['subject'] }} ‚Ä¢ {{ assignment['faculty_name'] }}</div>
            
            {% if assignment['description'] %}
            <p style="margin: 15px 0;">{{ assignment['description'] }}</p>
            {% endif %}

            <div class="info-row">
                <span class="info-label">Deadline:</span>
                <span class="info-value" id="deadline">{{ assignment['deadline'][:16].replace('T', ' ') }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Maximum Bonus:</span>
                <span class="info-value">{{ assignment['max_bonus_marks'] }} marks</span>
            </div>
            <div class="info-row">
                <span class="info-label">Reward Type:</span>
                <span class="info-value">{{ assignment['reward_type'].title() }}</span>
            </div>
            <div class="info-row">
                <span class="info-label">Submission Mode:</span>
                <span class="info-value">{{ assignment['submission_mode'].title() }}</span>
            </div>

            <div class="countdown" id="countdown"></div>
        </div>

        <div class="info-box">
            <strong>üìù How This Works:</strong><br>
            {% if assignment['submission_mode'] == 'online' %}
            1. Complete your assignment and prepare PDF file<br>
            2. Upload your PDF file below<br>
            3. Click "Submit Assignment" to submit online<br>
            4. Faculty will download and verify your submission<br>
            5. Bonus marks will be added after faculty approval
            {% else %}
            1. Complete your assignment offline (on paper/notebook)<br>
            2. Click "Mark as Submitted" below to record your submission time<br>
            3. Submit your physical assignment to your faculty<br>
            4. Faculty will verify and approve your submission after checking your work<br>
            5. Bonus marks will be added to your internal marks after faculty approval
            {% endif %}
        </div>

        <div class="bonus-calculator">
            <h3 style="text-align: center; margin-bottom: 10px;">üéÅ Your Potential Bonus</h3>
            <div class="bonus-value" id="potentialBonus">Calculating...</div>
            <div style="text-align: center; color: #666; font-size: 0.9em;">
                Submit now to lock in this bonus!
            </div>
        </div>

        {% if assignment['reward_type'] == 'tier' %}
        <div class="success">
            <strong>Tier-Based Rewards:</strong><br>
            ‚Ä¢ Submit within 25% of time: 100% bonus ({{ assignment['max_bonus_marks'] }} marks)<br>
            ‚Ä¢ Submit within 50% of time: 75% bonus ({{ assignment['max_bonus_marks'] * 0.75 }} marks)<br>
            ‚Ä¢ Submit within 75% of time: 50% bonus ({{ assignment['max_bonus_marks'] * 0.5 }} marks)<br>
            ‚Ä¢ Submit before deadline: 25% bonus ({{ assignment['max_bonus_marks'] * 0.25 }} marks)
        </div>
        {% elif assignment['reward_type'] == 'scaling' %}
        <div class="success">
            <strong>Linear Scaling:</strong> Your bonus decreases proportionally with time. The earlier you submit, the higher your bonus!
        </div>
        {% else %}
        <div class="success">
            <strong>Fixed Reward:</strong> Submit before the deadline to earn the full {{ assignment['max_bonus_marks'] }} marks bonus!
        </div>
        {% endif %}

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data" id="submitForm">
            {% if assignment['submission_mode'] == 'online' %}
            <div class="form-group">
                <label for="assignment_file">Upload Assignment (PDF) *</label>
                <input type="file" id="assignment_file" name="assignment_file" accept=".pdf" class="file-input" required>
                <small style="color: #666; display: block; margin-top: 10px;">
                    PDF file required for online submission (Max 16MB)
                </small>
            </div>
            {% endif %}

            <div class="warning">
                <strong>‚ö†Ô∏è Important:</strong> Once submitted, you cannot resubmit. 
                {% if assignment['submission_mode'] == 'online' %}
                Make sure your PDF file is correct and complete!
                {% else %}
                Make sure you have completed the assignment and are ready to submit it physically to faculty!
                {% endif %}
            </div>

            <div style="margin-top: 30px;">
                {% if assignment['submission_mode'] == 'online' %}
                <button type="submit" class="btn" onclick="return confirm('Are you sure you want to submit? You cannot resubmit after this.')">Submit Assignment</button>
                {% else %}
                <button type="submit" class="btn" onclick="return confirm('Have you completed the assignment and ready to submit it to faculty? This will record your submission time.')">Mark as Submitted</button>
                {% endif %}
                <a href="{{ url_for('student_assignments') }}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>

    <script>
        const deadline = new Date('{{ assignment["deadline"] }}');
        const createdAt = new Date('{{ assignment["created_at"] }}');
        const maxBonus = {{ assignment['max_bonus_marks'] }};
        const rewardType = '{{ assignment["reward_type"] }}';

        function calculateBonus() {
            const now = new Date();
            
            if (now > deadline) {
                document.getElementById('potentialBonus').textContent = '0 marks';
                document.getElementById('potentialBonus').style.color = '#dc3545';
                return 0;
            }

            const totalTime = deadline - createdAt;
            const timeTaken = now - createdAt;
            const remainingTime = deadline - now;
            const timePercentage = (timeTaken / totalTime) * 100;

            let bonus = 0;

            if (rewardType === 'fixed') {
                bonus = maxBonus;
            } else if (rewardType === 'tier') {
                if (timePercentage <= 25) {
                    bonus = maxBonus;
                } else if (timePercentage <= 50) {
                    bonus = maxBonus * 0.75;
                } else if (timePercentage <= 75) {
                    bonus = maxBonus * 0.50;
                } else {
                    bonus = maxBonus * 0.25;
                }
            } else if (rewardType === 'scaling') {
                bonus = maxBonus * (remainingTime / totalTime);
            }

            bonus = Math.max(0, bonus).toFixed(2);
            document.getElementById('potentialBonus').textContent = bonus + ' marks';
            return bonus;
        }

        function updateCountdown() {
            const now = new Date();
            const diff = deadline - now;

            if (diff <= 0) {
                document.getElementById('countdown').textContent = '‚è∞ Deadline passed';
                document.getElementById('countdown').style.color = '#dc3545';
                document.getElementById('submitForm').innerHTML = '<div class="warning">This assignment deadline has passed.</div>';
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);

            let countdownText = '‚è∞ Time remaining: ';
            if (days > 0) countdownText += days + 'd ';
            countdownText += hours + 'h ' + minutes + 'm ' + seconds + 's';

            document.getElementById('countdown').textContent = countdownText;

            if (diff < 3600000) { // Less than 1 hour
                document.getElementById('countdown').style.color = '#dc3545';
            } else if (diff < 86400000) { // Less than 1 day
                document.getElementById('countdown').style.color = '#ffc107';
            } else {
                document.getElementById('countdown').style.color = '#28a745';
            }
        }

        // Update every second
        calculateBonus();
        updateCountdown();
        setInterval(() => {
            calculateBonus();
            updateCountdown();
        }, 1000);
    </script>
</body>
</html>
